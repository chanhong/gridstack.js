name: Sync Documentation to gh-pages

on:
  push:
    branches: [master, develop]
    paths:
      - 'doc/html/**'
      - 'angular/doc/**'
      - '.github/workflows/sync-docs.yml'
  workflow_dispatch:

jobs:
  sync-docs:
    runs-on: ubuntu-latest
    if: github.repository == 'adumesny/gridstack.js'
    
    steps:
    - name: Checkout master branch
      uses: actions/checkout@v4
      with:
        ref: master
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Configure Git
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'

    - name: Check if docs exist
      id: check-docs
      run: |
        if [ -d "doc/html" ]; then
          echo "main_docs=true" >> $GITHUB_OUTPUT
        else
          echo "main_docs=false" >> $GITHUB_OUTPUT
        fi
        
        if [ -d "angular/doc/api" ]; then
          echo "angular_docs=true" >> $GITHUB_OUTPUT
        else
          echo "angular_docs=false" >> $GITHUB_OUTPUT
        fi

    - name: Checkout gh-pages branch
      if: steps.check-docs.outputs.main_docs == 'true' || steps.check-docs.outputs.angular_docs == 'true'
      run: |
        git fetch origin gh-pages
        git checkout gh-pages

    - name: Sync main library documentation
      if: steps.check-docs.outputs.main_docs == 'true'
      run: |
        echo "Syncing main library documentation..."
        
        # Remove existing doc/html directory if it exists
        if [ -d "doc/html" ]; then
          rm -rf doc/html
        fi
        
        # Extract docs from master branch using git archive
        mkdir -p doc
        git archive master doc/html | tar -xf -
        
        # Add changes
        git add doc/html

    - name: Sync Angular documentation
      if: steps.check-docs.outputs.angular_docs == 'true'
      run: |
        echo "Syncing Angular library documentation..."
        
        # Remove existing Angular docs if they exist
        if [ -d "angular/doc" ]; then
          rm -rf angular/doc
        fi
        
        # Extract Angular docs from master branch using git archive
        git archive master angular/doc | tar -xf -
        
        # Add changes
        git add angular/doc

    - name: Commit and push changes
      if: steps.check-docs.outputs.main_docs == 'true' || steps.check-docs.outputs.angular_docs == 'true'
      run: |
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "No documentation changes to sync"
          exit 0
        fi
        
        # Create commit message
        COMMIT_MSG="ðŸ“š Auto-sync documentation from master"
        if [ "${{ steps.check-docs.outputs.main_docs }}" == "true" ]; then
          COMMIT_MSG="${COMMIT_MSG}%0A%0A- Updated main library HTML docs (docs/html/)"
        fi
        if [ "${{ steps.check-docs.outputs.angular_docs }}" == "true" ]; then
          COMMIT_MSG="${COMMIT_MSG}%0A%0A- Updated Angular library docs (angular/doc/)"
        fi
        
        COMMIT_MSG="${COMMIT_MSG}%0A%0ASource: ${{ github.sha }}"
        
        # Decode URL-encoded newlines for the commit message
        COMMIT_MSG=$(echo -e "${COMMIT_MSG//%0A/\\n}")
        
        # Commit and push
        git commit -m "$COMMIT_MSG"
        git push origin gh-pages
        
        echo "âœ… Documentation synced to gh-pages successfully!"
